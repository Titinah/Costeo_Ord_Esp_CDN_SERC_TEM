<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Costeo por Órdenes | CDN Sercotec Temuco</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/x-icon" href="https://i.postimg.cc/kgDCs5xX/imagen-2026-01-08-145205602-preview-rev-1.png">

    <style>
        :root {
            --sercotec-blue: #004B8D;      
            --sercotec-dark: #1d3557;      
            --sercotec-red: #E30613;       
            --sercotec-light-blue: #ebf2fa;
            --bg-body: #f8f9fa;
        }

        body { 
            background-color: var(--bg-body); 
            font-family: 'Roboto', sans-serif; 
            min-height: 100vh;
        }

        .navbar-custom {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-top: 4px solid var(--sercotec-red);
            padding: 15px 0;
        }

        .card-custom {
            border: none;
            border-radius: 12px;
            background: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.02);
            margin-bottom: 20px;
        }

        .card-header-custom {
            background-color: white;
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 20px;
            font-weight: 600;
            color: var(--sercotec-blue);
            border-radius: 12px 12px 0 0;
        }

        /* --- ESTILOS DE PESTAÑAS MEJORADOS (PROFESIONAL) --- */
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
            gap: 4px; /* Espacio sutil entre pestañas */
        }

        .nav-tabs .nav-link { 
            color: #6c757d; 
            font-weight: 500; 
            border: none; 
            border-radius: 8px 8px 0 0; /* Bordes redondeados solo arriba */
            padding: 12px 24px;
            transition: all 0.3s ease; /* Transición suave */
            background-color: transparent;
            position: relative;
        }

        /* Efecto Hover (al pasar el mouse) */
        .nav-tabs .nav-link:hover {
            color: var(--sercotec-blue);
            background-color: rgba(0, 75, 141, 0.04); /* Azul muy tenue */
        }

        /* Estado Activo */
        .nav-tabs .nav-link.active { 
            color: var(--sercotec-blue); 
            font-weight: 700; 
            background-color: white;
            /* Borde superior rojo (identidad) y sombras suaves */
            box-shadow: 0 -3px 0 var(--sercotec-red) inset, 0 -5px 10px rgba(0,0,0,0.03); 
            border-bottom: 2px solid white; /* Conecta visualmente con el contenido */
            margin-bottom: -2px; /* Superpone la línea base */
        }

        /* Estilo especial para la pestaña RESULTADOS */
        .nav-tabs .nav-link.text-primary.active {
            color: var(--sercotec-red) !important; /* Rojo al estar activo para destacar */
            box-shadow: 0 -3px 0 var(--sercotec-blue) inset, 0 -5px 10px rgba(0,0,0,0.03);
        }

        .btn-primary-custom {
            background-color: var(--sercotec-blue);
            color: white;
            border: none;
            padding: 10px 20px;
            font-weight: 600;
            border-radius: 8px;
        }

        .kpi-result {
            background: var(--sercotec-light-blue);
            border-left: 5px solid var(--sercotec-blue);
            padding: 15px;
            border-radius: 8px;
        }

        .table-custom thead { background-color: var(--sercotec-light-blue); }

        /* --- ESPACIADO Y CUERPO DE LAS PESTAÑAS --- */
        .tab-content {
            background-color: white;
            padding: 10px 25px; 
            border: 1px solid #e9ecef; /* Borde sutil alrededor del contenido */
            border-top: none; /* Sin borde arriba para que se fusione con la pestaña */
            border-radius: 0 0 8px 8px; /* Redondear solo las esquinas inferiores */
            box-shadow: 0 4px 6px rgba(0,0,0,0.02); /* Sombra muy leve para profundidad */
            margin-bottom: 20px;
        }

	/* --- FOOTER --- */
        .footer-custom {
            margin-top: auto !important; 
            background-color: #212529;
            color: #ccc;
            padding: 40px 0 20px;
            font-size: 0.9rem;
            border-top: 5px solid var(--sercotec-red);
            flex-shrink: 0; 
        }
        .footer-title { color: white; font-weight: 700; margin-bottom: 15px; font-size: 1.1rem; }
        .footer-link { color: #ccc; text-decoration: none; transition: color 0.2s; display: block; margin-bottom: 8px; }
        .footer-link:hover { color: white; text-decoration: none; }
        .footer-social a { color: white; font-size: 3.0rem; margin-right: 15px; transition: opacity 0.2s; }
        .footer-social a:hover { opacity: 0.7; }
        .footer-divider { border-color: #444; margin: 20px 0; }

	/* --- MEJORAS DE IMPRESIÓN Y FOOTER --- */
        .text-sercotec-red { color: var(--sercotec-red); }
        
        @media print {
            .no-print, .btn-sm, .nav-tabs, .btn-outline-danger { 
                display: none !important; 
            }
            body { background-color: white !important; }
            .card-custom { box-shadow: none !important; border: 1px solid #dee2e6 !important; }
            /* Fuerza el despliegue de todas las pestañas en el reporte impreso */
            .tab-pane { display: block !important; opacity: 1 !important; visibility: visible !important; }
            .tab-content > .tab-pane { display: block !important; }
        }
	/* =========================================
       ESTILOS DE IMPRESIÓN PROFESIONAL (PDF)
       ========================================= */
    @media print {
        /* 1. Limpieza General */
        @page {
            margin: 1.5cm;
            size: auto;
        }
        
        body {
            background-color: white !important;
            font-family: 'Roboto', sans-serif;
            color: #000;
            padding-top: 0 !important;
        }

        /* 2. Ocultar Elementos de Interfaz (UI) */
        .btn, 
        .no-print, 
        .form-text, 
        .form-switch, 
        .input-group-text,
        footer,
        .shadow-sm,
        button {
            display: none !important;
        }

        /* 3. Transformar Inputs en Texto Plano */
        /* Esto hace que los cuadros de texto parezcan texto impreso */
        input.form-control, 
        select.form-control, 
        textarea.form-control {
            border: none !important;
            background: transparent !important;
            box-shadow: none !important;
            padding: 0 !important;
            margin: 0 !important;
            font-size: 0.95rem;
            color: #000 !important;
            width: auto !important;
            height: auto !important;
            resize: none;
            /* Ocultamos los placeholders para que no salga "Ej: ..." en el papel */
            -webkit-text-fill-color: #000;
        }
        
        ::placeholder {
            color: transparent !important;
            opacity: 0 !important;
        }

        /* 4. Estructura y Layout */
        .container {
            max-width: 100% !important;
            width: 100% !important;
            padding: 0 !important;
            margin: 0 !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
            margin-bottom: 20px !important;
        }

        .card-header {
            background-color: transparent !important;
            border-bottom: 2px solid #000 !important;
            padding-left: 0;
            color: #000 !important;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .card-body {
            padding: 10px 0 !important;
        }

        /* 5. Tablas Profesionales */
        .table {
            width: 100% !important;
            border-collapse: collapse !important;
            margin-bottom: 1rem !important;
            border: 1px solid #ddd !important;
        }
        
        .table th {
            background-color: #f0f0f0 !important; /* Gris muy suave para encabezados */
            color: #000 !important;
            border: 1px solid #000 !important;
            font-weight: bold;
            text-transform: uppercase;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .table td {
            border: 1px solid #ccc !important;
            padding: 4px 8px !important;
            vertical-align: middle;
        }

        /* Evitar que las filas se corten entre páginas */
        tr {
            break-inside: avoid;
            page-break-inside: avoid;
        }

        /* 6. Ajuste de la Sección de Resultados (Resumen Final) */
        #seccionResultados .card {
            border: 1px solid #000 !important; /* Recuadro para los totales */
            padding: 15px;
            break-inside: avoid;
        }

        #seccionResultados h4 {
            font-size: 1.2rem;
            border-bottom: 1px solid #000;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }

        /* Alineación de montos a la derecha */
        .text-end, .mat-total, .mo-total {
            text-align: right !important;
        }

        /* 7. Encabezado del Informe (Branding) */
        header {
            border-bottom: 2px solid var(--sercotec-red);
            margin-bottom: 20px;
            padding-bottom: 10px;
            text-align: center;
        }

        header h1 {
            font-size: 1.8rem !important;
            color: #000 !important;
        }
        
        header p {
            color: #555 !important;
        }
    }
    </style>
</head>
<body>

<nav class="navbar navbar-custom sticky-top no-print">
    <div class="container-fluid px-4">
        <div class="d-flex align-items-center">
            <img src="https://www.sercotec.cl/centros-de-negocios/wp-content/uploads/sites/4/2020/09/la-araucania-temuco-cdn-logo.png" alt="Sercotec" height="85" class="me-3">
            <div class="brand-text border-start ps-3 border-2">
                <h1 class="h5 mb-0 fw-bold" style="color: var(--sercotec-blue);">Costeo por Órdenes Específicas</h1>
                <p class="small mb-0 text-muted">Herramienta de Gestión</p>
	    </div>
        </div>
        <div class="d-flex gap-2 no-print">
            <button class="btn btn-outline-secondary btn-sm" onclick="limpiarTodo()">
                <i class="bi bi-eraser"></i> Limpiar
            </button>
            <button class="btn btn-primary-custom btn-sm text-white" onclick="window.print()">
                <i class="bi bi-file-earmark-pdf"></i> Imprimir / PDF
            </button>
	    </div>
        </div>
    </div>
</nav>

<div class="container py-4">
    <div class="row">
        <div class="col-lg-4">
            <div class="card-custom p-4">
                <h5 class="card-header-custom ps-0 pt-0 mb-3"><i class="bi bi-info-circle"></i> Información de la Orden</h5>
                <div class="mb-3">
                    <label class="form-label small fw-bold text-uppercase">Nombre del Producto</label>
                    <input type="text" id="detalle" class="form-control" placeholder="Ej: Mesa de Roble">
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold text-uppercase">N° de Orden</label>
                        <input type="text" id="numeroOrden" class="form-control" placeholder="001">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold text-uppercase">Cantidad (Unid.)</label>
                        <input type="number" id="cantidad" class="form-control" value="1" onchange="calcularTodo()">
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label small fw-bold text-uppercase">Margen Deseado (%)</label>
                    <div class="input-group">
                        <input type="number" id="margenDeseado" class="form-control" value="30" onchange="calcularTodo()">
                        <span class="input-group-text">%</span>
                    </div>
                </div>
                <div class="row">
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold text-uppercase">Fecha Inicio</label>
                        <input type="date" id="fecha" class="form-control">
                    </div>
                    <div class="col-6 mb-3">
                        <label class="form-label small fw-bold text-uppercase">Fecha Término</label>
                        <input type="date" id="fechaTermino" class="form-control">
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card-custom">
                <div class="card-body">
                    <ul class="nav nav-tabs mb-4" id="costingTabs" role="tablist">
                        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-materiales">Materiales</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-mano-obra">Mano de Obra</button></li>
                        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-cif">CIF (Indirectos)</button></li>
                        <li class="nav-item"><button class="nav-link text-primary" data-bs-toggle="tab" data-bs-target="#tab-resumen"><b>RESULTADOS</b></button></li>
                    </ul>

                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="tab-materiales">
                            <h6>Materiales Directos</h6>
                            <table class="table table-sm table-custom" id="tablaMateriales">
                                <thead><tr><th>Insumo</th><th>Cant.</th><th>Costo Unit.</th><th>Total</th><th></th></tr></thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" class="form-control form-control-sm" placeholder="Ej: Materia Prima"></td>
                                        <td><input type="text" class="form-control form-control-sm mat-q" placeholder="Ej: 5" oninput="formatearMoneda(this)" onchange="calcularTodo()"></td>
					<td><input type="text" class="form-control form-control-sm mat-p" placeholder="Ej: 1.500" oninput="formatearMoneda(this)" onchange="calcularTodo()"></td>
                                        <td class="mat-total">$0</td>
                                        <td><button class="btn btn-sm btn-outline-danger" onclick="eliminarFila(this)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="btn btn-sm btn-outline-secondary" onclick="agregarFila('tablaMateriales')">+ Agregar Material</button>
                        </div>

                        <div class="tab-pane fade" id="tab-mano-obra">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="mb-0">Mano de Obra Directa</h6>
        <div class="form-check form-switch bg-white px-3 py-1">
            <input class="form-check-input" type="checkbox" id="checkModoFijo" onchange="alternarModoManoObra()">
        </div>
    </div>
    
    <table class="table table-sm table-custom" id="tablaManoObra">
        <thead>
            <tr>
                <th>Operario/Tarea</th>
                <th id="th-mo-horas" class="col-hora">Horas</th>
                <th id="th-mo-valor">Valor Hora</th>
                <th>Total</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><input type="text" class="form-control form-control-sm" placeholder="Ej: Operario"></td>
                <td class="col-hora"><input type="text" class="form-control form-control-sm mo-q" placeholder="Ej: 8" oninput="formatearMoneda(this)" onchange="calcularTodo()"></td>
		<td><input type="text" class="form-control form-control-sm mo-p" placeholder="Ej: 3.000" oninput="formatearMoneda(this)" onchange="calcularTodo()"></td>
                <td class="mo-total">$0</td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="eliminarFila(this)"><i class="bi bi-trash"></i></button></td>
            </tr>
        </tbody>
    </table>
    <button class="btn btn-sm btn-outline-secondary" onclick="agregarFila('tablaManoObra')">+ Agregar Mano de Obra</button>
</div>

                        <div class="tab-pane fade" id="tab-cif">
                            <h6>Costos Indirectos de Fabricación (CIF)</h6>
                            <table class="table table-sm table-custom" id="tablaCIF">
                                <thead><tr><th>Concepto (Luz, Arriendo, etc)</th><th>Monto Asignado</th><th></th></tr></thead>
                                <tbody>
                                    <tr>
                                        <td><input type="text" class="form-control form-control-sm" placeholder="Ej: Gasto Básico"></td>
                                        <td><input type="text" class="form-control form-control-sm cif-v" placeholder="Ej: 10.000" oninput="formatearMoneda(this)"></td>
                                        <td><button class="btn btn-sm btn-outline-danger" onclick="eliminarFila(this)"><i class="bi bi-trash"></i></button></td>
                                    </tr>
                                </tbody>
                            </table>
                            <button class="btn btn-sm btn-outline-secondary" onclick="agregarFila('tablaCIF')">+ Agregar Costo Indirecto</button>
                        </div>

                        <div class="tab-pane fade text-center" id="tab-resumen">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <div class="kpi-result">
                                        <div class="small text-uppercase fw-bold text-muted">Costo Total de Orden</div>
                                        <h3 id="resCostoTotal">$0</h3>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="kpi-result" style="border-left-color: var(--sercotec-red);">
                                        <div class="small text-uppercase fw-bold text-muted">Costo Unitario</div>
                                        <h3 id="resCostoUnitario">$0</h3>
                                    </div>
                                </div>
                                <div class="col-12 mt-4 p-4 border rounded bg-white">
                                    <h4 class="text-sercotec mb-4">Sugerencia de Cobro</h4>
                                    <div class="row text-start border-bottom pb-2 mb-2">
                                        <div class="col-7">Margen de Ganancia Obtenido:</div>
                                        <div class="col-5 fw-bold text-success text-end" id="resMargenFinal">$0</div>
                                    </div>
                                    <div class="row text-start border-bottom pb-2 mb-2">
                                        <div class="col-7">Precio Neto (Unitario):</div>
                                        <div class="col-5 fw-bold text-end" id="resPrecioNeto">$0</div>
                                    </div>
                                    <div class="row text-start border-bottom pb-2 mb-2">
                                        <div class="col-7">IVA Débito (19%):</div>
                                        <div class="col-5 text-end" id="resIVA">$0</div>
                                    </div>
                                    <div class="row text-start pt-2">
                                        <div class="col-7 h5 fw-bold text-primary">PRECIO FINAL CLIENTE:</div>
                                        <div class="col-5 h5 fw-bold text-primary text-end" id="resPrecioFinal">$0</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<footer class="footer-custom no-print">
    <div class="container">
        <div class="row">
            <div class="col-md-4 mb-4">
                <h5 class="footer-title">Síguenos</h5>
                
                <div class="footer-social mt-3">
                    <a href="https://www.instagram.com/cdntemuco?igsh=N3A3enRscWc4bzFw" target="_blank"><i class="bi bi-instagram"></i></a>
                    <a href="https://www.facebook.com/cdnsercotectemuco" target="_blank"><i class="bi bi-facebook"></i></a>
                    <a href="https://www.sercotec.cl/centros-de-negocios/centro-de-desarrollo-de-negocios-temuco%E2%80%8B/" target="_blank"><i class="bi bi-globe"></i></a>
                </div>
            </div>
            <div class="col-md-4 mb-4">
                <h5 class="footer-title">Contacto</h5>
                <p class="mb-2"><i class="bi bi-geo-alt me-2 text-danger"></i> D. Portales N°806 - 4° Piso, Temuco</p>
                <p class="mb-2"><i class="bi bi-envelope me-2 text-danger"></i> centro.temuco@centrossercotec.cl</p>
                <p class="mb-2"><i class="bi bi-telephone me-2 text-danger"></i> +56 45 2 596 773</p>
                <p class="mb-2"><i class="bi bi-clock me-2 text-danger"></i> Lun - Vie: 09:00 - 18:00</p>
            </div>
            <div class="col-md-4 mb-4">
                <h5 class="footer-title">Enlaces de Interés</h5>
                <a href="https://www.sercotec.cl" class="footer-link">Sitio Web Sercotec</a>
                <a href="https://capacitacion.sercotec.cl" class="footer-link">Portal de Capacitación</a>
            </div>
        </div>
        <hr class="footer-divider">
        <div class="row align-items-center">
            <div class="col-md-6 text-center text-md-start">
                <small>&copy; 2026 - Centro de Negocios Sercotec Temuco. Todos los derechos reservados.</small>
            </div>
            <div class="col-md-6 text-center text-md-end mt-2 mt-md-0">
                <img src="https://www.sercotec.cl/wp-content/uploads/2018/08/logo.png" alt="Sercotec Blanco" height="30" style="opacity: 0.6;">
            </div>
        </div>
    </div>

    <button onclick="alert('Consideración: Los resultados son estimativos y de caracter ilustrativo, no representan una realidad exacta sobre los costos, sea cauteloso con lo aqui mostrado. Además, si te gustó mi sitio o necesitas ayuda, contáctame a: personalinvestments.live@gmail.com. Ten un buen día :)')" 
            class="btn btn-light border shadow-sm no-print"
            style="position: fixed; bottom: 10px; right: 10px; z-index: 9999; border-radius: 20px; font-size: 11px; padding: 4px 10px; opacity: 0.9;">
        <i class="bi bi-envelope-heart text-danger"></i> Info
    </button>
</footer>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Lógica profesional de impresión
    const tituloOriginalPestana = "Costeo por Órdenes | CDN Sercotec Temuco";

    window.onbeforeprint = function() {
        const producto = document.getElementById('producto').value.trim() || "Orden_de_Produccion";
        const numOrden = document.getElementById('numOrden').value.trim() || "000";
        const fecha = new Date().toLocaleDateString('es-CL').replace(/\//g, '-'); 
        // Cambia el título dinámicamente para el nombre del archivo PDF
        document.title = `${producto}_Orden-${numOrden}_CDN-TCO_${fecha}`;
    };

    window.onafterprint = function() {
        document.title = tituloOriginalPestana;
    };

    const fmt = new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP' });

    function agregarFila(tablaId) {
        const tabla = document.getElementById(tablaId).getElementsByTagName('tbody')[0];
        const nuevaFila = tabla.insertRow();
        if(tablaId === 'tablaCIF') {
            nuevaFila.innerHTML = `<td><input type="text" class="form-control form-control-sm" placeholder="${tablaCIF ? 'Ej: Gasto Básico' : ''}"></td>
                                   <td><input type="text" class="form-control form-control-sm cif-v" placeholder="Ej: 10.000" oninput="formatearMoneda(this)"></td>
                                   <td><button class="btn btn-sm btn-outline-danger" onclick="eliminarFila(this)"><i class="bi bi-trash"></i></button></td>`;
        } else {
            const clase = tablaId === 'tablaMateriales' ? 'mat' : 'mo';
	    const esManoObra = tablaId === 'tablaManoObra';
            const switchFijo = document.getElementById('checkModoFijo');
            const esModoFijo = esManoObra && switchFijo && switchFijo.checked;
            const estiloOculto = esModoFijo ? 'style="display: none;"' : '';
            const valorInicialQ = esModoFijo ? '1' : '';
            const claseCeldaExtra = esManoObra ? 'col-hora' : ''; 
            const phDesc = esManoObra ? 'Ej: Operario' : 'Ej: Materia Prima';

	    let phCant = '';
            if (!esManoObra) phCant = 'Ej: 5'; 
            else if (!esModoFijo) phCant = 'Ej: 8';

	    let phPrecio = '';
            if (esModoFijo) phPrecio = 'Monto Total';
            else if (!esManoObra) phPrecio = 'Ej: 1.500';
            else phPrecio = 'Ej: 3.000';

            nuevaFila.innerHTML = `
		<td><input type="text" class="form-control form-control-sm" placeholder="${phDesc}"></td>
                
                <td class="${claseCeldaExtra}" ${estiloOculto}>
                    <input type="text" class="form-control form-control-sm ${clase}-q" value="${valorInicialQ}" placeholder="${phCant}" oninput="formatearMoneda(this)" onchange="calcularTodo()">
                </td>
                
                <td>
                    <input type="text" class="form-control form-control-sm ${clase}-p" placeholder="${phPrecio}" oninput="formatearMoneda(this)" onchange="calcularTodo()">
                </td>
                
                <td class="${clase}-total">$0</td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="eliminarFila(this)"><i class="bi bi-trash"></i></button></td>
            `;
            }
        }

    function eliminarFila(btn) {
        btn.closest('tr').remove();
        calcularTodo();
    }

// --- NUEVA LÓGICA PARA MANO DE OBRA ---
    function alternarModoManoObra() {
        const esFijo = document.getElementById('checkModoFijo').checked;
        const thHoras = document.getElementById('th-mo-horas');
        const thValor = document.getElementById('th-mo-valor');
        
        // 1. Alternar encabezados
        if(thHoras) thHoras.style.display = esFijo ? 'none' : 'table-cell';
        if(thValor) thValor.innerText = esFijo ? 'Valor Total ($)' : 'Valor Hora ($)';

        // 2. Alternar celdas y valores
        document.querySelectorAll('#tablaManoObra tbody tr').forEach(tr => {
            const tdHora = tr.querySelector('.col-hora');
            const inputQ = tr.querySelector('.mo-q'); // Input de Cantidad/Horas
            const inputP = tr.querySelector('.mo-p'); // Input de Precio/Valor

            if(tdHora && inputQ) {
                if(esFijo) {
                    // Modo Fijo: Ocultamos horas y forzamos valor 1 para que la fórmula (1 * Precio) funcione
                    tdHora.style.display = 'none';
                    // Guardamos el valor previo por si vuelve a cambiar, y ponemos 1
                    inputQ.dataset.oldVal = inputQ.value; 
                    inputQ.value = 1;
                    if(inputP) inputP.placeholder = "Monto Total";
                } else {
                    // Modo Horas: Mostramos horas y restauramos valor
                    tdHora.style.display = 'table-cell';
                    if(inputQ.dataset.oldVal) inputQ.value = inputQ.dataset.oldVal;
                    if(inputP) inputP.placeholder = "Ej: 3.000";
                }
            }
        });
        
        calcularTodo(); // Recalcular inmediatamente
    }

// --- FUNCIONES PARA FORMATO DE MILES ---
    
    // 1. Formatea visualmente el input mientras escribes (Ej: 1000 -> 1.000)
    function formatearMoneda(input) {
        // 1. Guardar la posición del cursor para que no salte al final al editar
        let start = input.selectionStart;
        let oldLength = input.value.length;

        // 2. Limpiar todo lo que no sea número (elimina puntos previos y letras)
        let valorLimpio = input.value.replace(/\D/g, '');
        
        if (valorLimpio === '') {
            input.value = '';
        } else {
            // 3. Aplicar formato Chile (Puntos para miles)
            // Esto soluciona tu problema de comas: es-CL usa puntos para miles.
            input.value = new Intl.NumberFormat('es-CL').format(valorLimpio);
        }

        // 4. Recalcular inmediatamente
        calcularTodo();
        
        // Ajuste inteligente del cursor (opcional, para mejor experiencia de usuario)
        let newLength = input.value.length;
        start = start + (newLength - oldLength);
        try { input.setSelectionRange(start, start); } catch(e){} 
    }

    // 2. Limpia el formato para poder calcular (Ej: "1.000" -> 1000)
    function obtenerValor(input) {
        if (!input || input.value === '') return 0;
        // Quita los puntos y convierte a número real
        return parseFloat(input.value.replace(/\./g, '')) || 0;
    }

    function calcularTodo() {
        let totalMat = 0, totalMO = 0, totalCIF = 0;

        // Calcular Materiales
        document.querySelectorAll('#tablaMateriales tbody tr').forEach(tr => {
            const q = parseFloat(tr.querySelector('.mat-q').value || 0);
            const p = obtenerValor(tr.querySelector('.mat-p'));
            const sub = q * p;
            totalMat += sub;
            tr.querySelector('.mat-total').innerText = fmt.format(sub);
        });

        // Calcular Mano de Obra
        document.querySelectorAll('#tablaManoObra tbody tr').forEach(tr => {
            const q = parseFloat(tr.querySelector('.mo-q').value || 0);
            const p = obtenerValor(tr.querySelector('.mo-p'));
            const sub = q * p;
            totalMO += sub;
            tr.querySelector('.mo-total').innerText = fmt.format(sub);
        });

        // Calcular CIF
        document.querySelectorAll('.cif-v').forEach(input => {
            totalCIF += obtenerValor(input);
        });

        const costoTotalOrden = totalMat + totalMO + totalCIF;
        const cantidadUnidades = parseFloat(document.getElementById('cantidad').value || 1);
        const costoUnitario = costoTotalOrden / cantidadUnidades;
        
        // Lógica de Margen según requerimiento: Costo Unitario / (1 - Margen%)
        const mDeseado = (parseFloat(document.getElementById('margenDeseado').value || 0)) / 100;
        const precioNetoUnitario = mDeseado >= 1 ? costoUnitario : costoUnitario / (1 - mDeseado);
        const margenObtenido = precioNetoUnitario - costoUnitario;
        const iva = precioNetoUnitario * 0.19;
        const precioFinal = precioNetoUnitario + iva;

        // Renderizar Resultados
        document.getElementById('resCostoTotal').innerText = fmt.format(costoTotalOrden);
        document.getElementById('resCostoUnitario').innerText = fmt.format(costoUnitario);
        document.getElementById('resMargenFinal').innerText = fmt.format(margenObtenido);
        document.getElementById('resPrecioNeto').innerText = fmt.format(precioNetoUnitario);
        document.getElementById('resIVA').innerText = fmt.format(iva);
        document.getElementById('resPrecioFinal').innerText = fmt.format(precioFinal);
    }

   // ==========================================
    // SISTEMA DE PERSISTENCIA Y LIMPIEZA (CORREGIDO)
    // ==========================================

    function guardarDatos() {
        // NOTA: Asegúrate que tus inputs en el HTML tengan estos IDs exactos
        const datos = {
            inputs: {
                // Datos del Cliente y Producto
                cliente: document.getElementById('cliente')?.value || '',
                detalle: document.getElementById('detalle')?.value || '', // Verifica si tu input tiene id="detalle" o "producto"
                numeroOrden: document.getElementById('numeroOrden')?.value || '',
                
                // Fechas (Inicio y Término)
                fecha: document.getElementById('fecha')?.value || '',       // Fecha Inicio (id="fecha")
                fechaTermino: document.getElementById('fechaTermino')?.value || '', // Fecha Término (id="fechaTermino")
                
                // Cantidades y Margen
                cantidad: document.getElementById('cantidad')?.value || '',
                margenDeseado: document.getElementById('margenDeseado')?.value || ''
            },
            config: {
                modoFijo: document.getElementById('checkModoFijo')?.checked || false
            },
            tablas: {
                materiales: obtenerDatosDeTabla('tablaMateriales', ['.mat-q', '.mat-p']),
                manoObra: obtenerDatosDeTabla('tablaManoObra', ['.mo-q', '.mo-p']),
                cif: obtenerDatosDeTabla('tablaCIF', ['.cif-v'])
            }
        };
        localStorage.setItem('costeoSercotecData', JSON.stringify(datos));
    }

    function cargarDatos() {
        const json = localStorage.getItem('costeoSercotecData');
        if (!json) return;
        
        const datos = JSON.parse(json);

        // 1. Restaurar Inputs (Iteramos para mayor seguridad)
        Object.keys(datos.inputs).forEach(id => {
            const el = document.getElementById(id);
            if(el) el.value = datos.inputs[id];
        });

        // 2. Restaurar Modo Fijo
        const switchFijo = document.getElementById('checkModoFijo');
        if(switchFijo) {
            switchFijo.checked = datos.config.modoFijo;
            // Ejecutamos la lógica visual del switch si existe la función
            if(typeof alternarModoManoObra === 'function') alternarModoManoObra();
        }

        // 3. Restaurar Tablas
        reconstruirTabla('tablaMateriales', datos.tablas.materiales);
        reconstruirTabla('tablaManoObra', datos.tablas.manoObra);
        reconstruirTabla('tablaCIF', datos.tablas.cif);

        // 4. Calcular al final
        calcularTodo();
    }

    // --- NUEVA FUNCIÓN PARA EL BOTÓN LIMPIAR ---
    function limpiarTodo() {
        if(confirm('¿Estás seguro de querer borrar todos los datos y reiniciar el formulario?')) {
            // 1. Borrar la memoria del navegador
            localStorage.removeItem('costeoSercotecData');
            
            // 2. Recargar la página para que se limpie todo visualmente
            location.reload();
        }
    }

    // Funciones auxiliares (Se mantienen igual)
    function obtenerDatosDeTabla(idTabla, clases) {
        const filas = [];
        const tbody = document.getElementById(idTabla).getElementsByTagName('tbody')[0];
        tbody.querySelectorAll('tr').forEach(tr => {
            const inputDesc = tr.cells[0].querySelector('input'); 
            const filaData = { desc: inputDesc ? inputDesc.value : '' };
            clases.forEach(clase => {
                const key = clase.replace('.', '');
                const input = tr.querySelector(clase);
                filaData[key] = input ? input.value : '';
            });
            filas.push(filaData);
        });
        return filas;
    }

    function reconstruirTabla(idTabla, filasGuardadas) {
        if(!filasGuardadas || filasGuardadas.length === 0) return;
        const tbody = document.getElementById(idTabla).getElementsByTagName('tbody')[0];
        tbody.innerHTML = ''; 
        filasGuardadas.forEach(fila => {
            agregarFila(idTabla);
            const tr = tbody.lastElementChild;
            const inputDesc = tr.cells[0].querySelector('input');
            if(inputDesc) inputDesc.value = fila.desc;

            if(idTabla === 'tablaMateriales') {
                if(tr.querySelector('.mat-q')) tr.querySelector('.mat-q').value = fila['mat-q'];
                if(tr.querySelector('.mat-p')) tr.querySelector('.mat-p').value = fila['mat-p'];
            } else if(idTabla === 'tablaManoObra') {
                if(tr.querySelector('.mo-q')) tr.querySelector('.mo-q').value = fila['mo-q'];
                if(tr.querySelector('.mo-p')) tr.querySelector('.mo-p').value = fila['mo-p'];
            } else if(idTabla === 'tablaCIF') {
                if(tr.querySelector('.cif-v')) tr.querySelector('.cif-v').value = fila['cif-v'];
            }
        });
    }

    // Activadores
    document.addEventListener('input', guardarDatos);
    document.addEventListener('change', guardarDatos);
    document.addEventListener('DOMContentLoaded', cargarDatos);
    
    // Sobrescribir eliminar
    window.eliminarFila = function(btn) {
        const row = btn.closest('tr');
        row.remove();
        calcularTodo();
        guardarDatos();
    };

</script>
</body>

</html>
